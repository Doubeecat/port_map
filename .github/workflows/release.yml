name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # å½“æ¨é€ v1.0.0 è¿™æ ·çš„æ ‡ç­¾æ—¶è§¦å‘

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        
    - name: æ„å»º exe
      run: |
        pyinstaller --onefile --windowed --name port_map --clean port_map.py
        
    - name: è·å–ç‰ˆæœ¬å·
      id: get_version
      shell: bash
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
    - name: åˆ›å»º Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: ç«¯å£æ˜ å°„å·¥å…· ${{ steps.get_version.outputs.VERSION }}
        body: |
          ## ç«¯å£æ˜ å°„å·¥å…· ${{ steps.get_version.outputs.VERSION }}
          
          ### åŠŸèƒ½ç‰¹ç‚¹
          - ğŸ–¥ï¸ ç°ä»£åŒ–å›¾å½¢ç”¨æˆ·ç•Œé¢ï¼Œå¯è°ƒæ•´çª—å£å¤§å°
          - ğŸ”„ ä¸€é”®åˆ›å»º/åˆ é™¤ç«¯å£æ˜ å°„
          - âœ… è‡ªåŠ¨éªŒè¯IPåœ°å€å’Œç«¯å£æ ¼å¼
          - ğŸ“Š å®æ—¶çŠ¶æ€æ˜¾ç¤ºå’Œæ—¥å¿—è®°å½•ï¼ˆå¸¦æ»šåŠ¨æ¡ï¼‰
          - ğŸ” è‡ªåŠ¨æ£€æµ‹ç°æœ‰æ˜ å°„
          - ğŸ’¡ å°†è¿œç¨‹ç«¯å£æ˜ å°„åˆ°æœ¬åœ°22ç«¯å£
          
          ### æ˜ å°„è¯´æ˜
          **æ˜ å°„æ–¹å‘**: è¿œç¨‹IP:ç«¯å£ â†’ æœ¬åœ°127.0.0.1:22
          
          ä¾‹å¦‚ï¼šå°† 192.168.1.100:2222 æ˜ å°„åˆ°æœ¬åœ°22ç«¯å£
          
          ### ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½ `port_map.exe`
          2. å³é”®é€‰æ‹©"ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ"
          3. è¾“å…¥è¿œç¨‹IPåœ°å€å’Œç«¯å£
          4. ç‚¹å‡»"åˆ›å»ºæ˜ å°„"æŒ‰é’®
          
          ### ç³»ç»Ÿè¦æ±‚
          - Windows 7/8/10/11
          - ç®¡ç†å‘˜æƒé™
          
          ### æ³¨æ„äº‹é¡¹
          âš ï¸ æœ¬ç¨‹åºå¿…é¡»ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œæ‰èƒ½åˆ›å»ºç«¯å£æ˜ å°„
          
          ---
          
          å®Œæ•´æ–‡æ¡£è¯·æŸ¥çœ‹ [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
        draft: false
        prerelease: false
        
    - name: ä¸Šä¼  Release èµ„æº
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./dist/port_map.exe
        asset_name: port_map.exe
        asset_content_type: application/octet-stream
